<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tirol DGM · Bereichsauswahl</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<style>
  :root {
    --bg: #0e1117;
    --surface: #161b27;
    --surface2: #1e2535;
    --border: #2a3349;
    --accent: #4af0a8;
    --accent2: #f0a84a;
    --text: #e8edf5;
    --muted: #6b7a99;
    --danger: #f05a6b;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* ── HEADER ── */
  header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    z-index: 1000;
  }

  .logo {
    font-size: 18px;
    font-weight: 800;
    letter-spacing: -0.5px;
  }
  .logo span { color: var(--accent); }

  .subtitle {
    font-size: 11px;
    font-weight: 400;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    letter-spacing: 0.05em;
  }

  .header-right {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .badge {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 3px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
  }
  .badge.active { border-color: var(--accent); color: var(--accent); }

  /* ── MAIN LAYOUT ── */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* ── MAP ── */
  #map {
    flex: 1;
    background: var(--bg);
    cursor: crosshair;
  }

  /* Leaflet overrides */
  .leaflet-container { font-family: 'Syne', sans-serif; }
  .leaflet-control-attribution {
    background: rgba(14,17,23,0.85) !important;
    color: var(--muted) !important;
    font-size: 10px;
  }
  .leaflet-control-attribution a { color: var(--muted) !important; }
  .leaflet-control-zoom a {
    background: var(--surface) !important;
    color: var(--text) !important;
    border-color: var(--border) !important;
  }
  .leaflet-control-zoom a:hover { background: var(--surface2) !important; color: var(--accent) !important; }

  /* ── SIDEBAR ── */
  .sidebar {
    width: 320px;
    background: var(--surface);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    flex-shrink: 0;
  }

  .panel {
    padding: 18px;
    border-bottom: 1px solid var(--border);
  }

  .panel-title {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 14px;
    font-family: 'Space Mono', monospace;
  }

  /* ── INSTRUCTION ── */
  .instruction {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
    font-size: 13px;
    color: var(--muted);
    line-height: 1.5;
  }
  .instruction .icon {
    font-size: 18px;
    flex-shrink: 0;
    margin-top: 1px;
  }

  /* ── COORD DISPLAY ── */
  .coord-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 10px;
  }

  .coord-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 12px;
  }
  .coord-item.highlight {
    border-color: var(--accent);
  }

  .coord-label {
    font-size: 10px;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    margin-bottom: 4px;
    letter-spacing: 0.05em;
  }

  .coord-value {
    font-size: 14px;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    color: var(--text);
  }
  .coord-item.highlight .coord-value { color: var(--accent); }

  .coord-empty {
    color: var(--muted);
    font-size: 12px;
    font-family: 'Space Mono', monospace;
    opacity: 0.5;
  }

  /* area info */
  .area-info {
    display: flex;
    gap: 8px;
    margin-top: 4px;
  }

  .area-chip {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px;
    text-align: center;
  }
  .area-chip .val {
    font-size: 16px;
    font-weight: 700;
    font-family: 'Space Mono', monospace;
    color: var(--accent2);
  }
  .area-chip .unit {
    font-size: 10px;
    color: var(--muted);
    margin-top: 2px;
  }

  /* ── CODE OUTPUT ── */
  .code-block {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 14px;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    line-height: 1.7;
    color: #a8c4e8;
    position: relative;
    overflow-x: auto;
    white-space: pre;
  }

  .code-block .comment { color: #4a6280; }
  .code-block .kw { color: #c792ea; }
  .code-block .str { color: #c3e88d; }
  .code-block .num { color: var(--accent); }
  .code-block .placeholder { color: var(--muted); font-style: italic; }

  .copy-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
  .copy-btn.copied { border-color: var(--accent); color: var(--accent); }

  /* ── RESOLUTION ── */
  .res-toggle {
    display: flex;
    gap: 6px;
  }

  .res-btn {
    flex: 1;
    padding: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
  }
  .res-btn:hover { border-color: var(--accent); color: var(--text); }
  .res-btn.active { border-color: var(--accent); background: rgba(74,240,168,0.08); color: var(--accent); }

  /* ── PRESETS ── */
  .preset-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .preset-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
    text-align: left;
    width: 100%;
  }
  .preset-btn:hover { border-color: var(--accent2); }

  .preset-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent2);
    flex-shrink: 0;
  }

  .preset-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
  }
  .preset-sub {
    font-size: 10px;
    font-family: 'Space Mono', monospace;
    color: var(--muted);
    margin-top: 1px;
  }

  /* ── CLEAR BTN ── */
  .clear-btn {
    width: 100%;
    padding: 10px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--danger);
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.03em;
  }
  .clear-btn:hover { background: rgba(240,90,107,0.1); border-color: var(--danger); }

  /* ── WARNING BOX ── */
  .warning {
    background: rgba(240,168,74,0.08);
    border: 1px solid rgba(240,168,74,0.3);
    border-radius: 6px;
    padding: 10px 12px;
    font-size: 12px;
    color: var(--accent2);
    line-height: 1.5;
    display: none;
  }
  .warning.show { display: block; }

  /* ── MAP RECTANGLE STYLE ── */
  /* applied via Leaflet options */

  /* ── SCROLLBAR ── */
  .sidebar::-webkit-scrollbar { width: 4px; }
  .sidebar::-webkit-scrollbar-track { background: transparent; }
  .sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>

<header>
  <div>
    <div class="logo">Tirol <span>DGM</span> Selector</div>
    <div class="subtitle">WCS · EPSG:31254 · Land Tirol</div>
  </div>
  <div class="header-right">
    <div class="badge active" id="status-badge">Bereit</div>
    <div class="badge">5m / 50cm Auflösung</div>
  </div>
</header>

<div class="main">
  <div id="map"></div>

  <div class="sidebar">

    <!-- Instruction -->
    <div class="panel">
      <div class="panel-title">Anleitung</div>
      <div class="instruction">
        <span class="icon">⬛</span>
        <span>Klicke und ziehe auf der Karte um einen Bereich auszuwählen. Die BBOX-Koordinaten werden automatisch in <strong>EPSG:31254</strong> umgerechnet.</span>
      </div>
    </div>

    <!-- Coordinates -->
    <div class="panel">
      <div class="panel-title">Bounding Box · EPSG:31254</div>
      <div class="coord-grid">
        <div class="coord-item" id="coord-ymin">
          <div class="coord-label">y_min</div>
          <div class="coord-value coord-empty" id="val-ymin">—</div>
        </div>
        <div class="coord-item" id="coord-xmin">
          <div class="coord-label">x_min</div>
          <div class="coord-value coord-empty" id="val-xmin">—</div>
        </div>
        <div class="coord-item" id="coord-ymax">
          <div class="coord-label">y_max</div>
          <div class="coord-value coord-empty" id="val-ymax">—</div>
        </div>
        <div class="coord-item" id="coord-xmax">
          <div class="coord-label">x_max</div>
          <div class="coord-value coord-empty" id="val-xmax">—</div>
        </div>
      </div>

      <div class="area-info" id="area-info" style="display:none">
        <div class="area-chip">
          <div class="val" id="area-w">—</div>
          <div class="unit">Breite (km)</div>
        </div>
        <div class="area-chip">
          <div class="val" id="area-h">—</div>
          <div class="unit">Höhe (km)</div>
        </div>
        <div class="area-chip">
          <div class="val" id="area-total">—</div>
          <div class="unit">Fläche (km²)</div>
        </div>
      </div>

      <div class="warning" id="size-warning">
        ⚠ Großer Bereich! Bei 50cm Auflösung entstehen sehr große Dateien.
      </div>
    </div>

    <!-- Resolution -->
    <div class="panel">
      <div class="panel-title">Auflösung</div>
      <div class="res-toggle">
        <div class="res-btn active" id="res-5m" onclick="setResolution('5m')">
          <div>5m</div>
          <div style="font-size:9px;color:var(--muted);margin-top:2px">Standard</div>
        </div>
        <div class="res-btn" id="res-50cm" onclick="setResolution('50cm')">
          <div>50cm</div>
          <div style="font-size:9px;color:var(--muted);margin-top:2px">Sehr groß!</div>
        </div>
      </div>
    </div>

    <!-- Python Code -->
    <div class="panel">
      <div class="panel-title">Python Code</div>
      <div class="code-block" id="code-output">
<span class="comment"># Bereich auswählen um Code</span>
<span class="comment"># zu generieren...</span>

<span class="placeholder">BBOX = (y_min, x_min,
        y_max, x_max)</span>
        <button class="copy-btn" id="copy-btn" onclick="copyCode()">Copy</button>
      </div>
    </div>

    <!-- Presets -->
    <div class="panel">
      <div class="panel-title">Schnellauswahl</div>
      <div class="preset-list">
        <button class="preset-btn" onclick="applyPreset(212983,23647,218983,29647,'Kaunertal Start')">
          <div class="preset-dot"></div>
          <div>
            <div class="preset-name">Kaunertal Start</div>
            <div class="preset-sub">~6×6 km · Standard-Beispiel</div>
          </div>
        </button>
        <button class="preset-btn" onclick="applyPreset(230000,74000,236000,80000,'Innsbruck Altstadt')">
          <div class="preset-dot"></div>
          <div>
            <div class="preset-name">Innsbruck Altstadt</div>
            <div class="preset-sub">~6×6 km</div>
          </div>
        </button>
        <button class="preset-btn" onclick="applyPreset(234000,60000,244000,70000,'Innsbruck Region')">
          <div class="preset-dot"></div>
          <div>
            <div class="preset-name">Innsbruck Region</div>
            <div class="preset-sub">~10×10 km</div>
          </div>
        </button>
        <button class="preset-btn" onclick="applyPreset(195000,20000,210000,35000,'Kaunertal Gesamt')">
          <div class="preset-dot"></div>
          <div>
            <div class="preset-name">Kaunertal Gesamt</div>
            <div class="preset-sub">~15×15 km</div>
          </div>
        </button>
        <button class="preset-btn" onclick="applyPreset(165000,150000,175000,160000,'Kitzbühel')">
          <div class="preset-dot"></div>
          <div>
            <div class="preset-name">Kitzbühel</div>
            <div class="preset-sub">~10×10 km</div>
          </div>
        </button>
      </div>
    </div>

    <!-- Clear -->
    <div class="panel">
      <button class="clear-btn" onclick="clearSelection()">✕ Auswahl löschen</button>
    </div>

  </div><!-- /sidebar -->
</div><!-- /main -->

<script>
// ── proj4 für EPSG:31254 ──────────────────────────────────────────────────
// EPSG:31254 = MGI / Austria GK West
// Proj4 string
const PROJ_31254 = '+proj=tmerc +lat_0=0 +lon_0=10.33333333333333 +k=1 +x_0=0 +y_0=-5000000 +ellps=bessel +towgs84=577.326,90.129,463.919,5.137,1.474,5.297,2.4232 +units=m +no_defs';

// Minimal proj4 implementation (Transverse Mercator + Bessel + Helmert)
function toEPSG31254(lat, lon) {
  // WGS84 -> Bessel 1841 (Helmert 7-parameter)
  const dX=577.326, dY=90.129, dZ=463.919;
  const rX=5.137/206265, rY=1.474/206265, rZ=5.297/206265, s=2.4232/1e6;

  const a_wgs=6378137.0, f_wgs=1/298.257223563;
  const b_wgs=a_wgs*(1-f_wgs);
  const e2_wgs=1-(b_wgs/a_wgs)**2;

  const latR=lat*Math.PI/180, lonR=lon*Math.PI/180;
  const sinLat=Math.sin(latR), cosLat=Math.cos(latR);
  const sinLon=Math.sin(lonR), cosLon=Math.cos(lonR);

  const N_wgs=a_wgs/Math.sqrt(1-e2_wgs*sinLat**2);
  const h=50; // approx ellipsoidal height
  const X=(N_wgs+h)*cosLat*cosLon;
  const Y=(N_wgs+h)*cosLat*sinLon;
  const Z=(N_wgs*(1-e2_wgs)+h)*sinLat;

  // Helmert
  const Xb=(1+s)*(X + rZ*Y - rY*Z) + dX;
  const Yb=(1+s)*(-rZ*X + Y + rX*Z) + dY;
  const Zb=(1+s)*(rY*X - rX*Y + Z) + dZ;

  // Bessel 1841
  const a_bes=6377397.155, f_bes=1/299.1528128;
  const b_bes=a_bes*(1-f_bes);
  const e2_bes=1-(b_bes/a_bes)**2;

  const p=Math.sqrt(Xb**2+Yb**2);
  let lat_bes=Math.atan2(Zb, p*(1-e2_bes));
  for(let i=0;i<10;i++){
    const N_=a_bes/Math.sqrt(1-e2_bes*Math.sin(lat_bes)**2);
    lat_bes=Math.atan2(Zb+e2_bes*N_*Math.sin(lat_bes), p);
  }
  const lon_bes=Math.atan2(Yb, Xb);

  // Gauss-Krüger (TM) lon0=10.33333°
  const lon0=10.333333333333*Math.PI/180;
  const dlon=lon_bes-lon0;
  const sinB=Math.sin(lat_bes), cosB=Math.cos(lat_bes), tanB=Math.tan(lat_bes);
  const N_b=a_bes/Math.sqrt(1-e2_bes*sinB**2);
  const e2_=e2_bes*cosB**2/(1-e2_bes);
  const t=tanB;
  const n2=e2_;
  const dl=dlon;

  // meridian arc
  const n=(a_bes-b_bes)/(a_bes+b_bes);
  const A0=1 - n**2/4 - 3*n**4/64;
  const A2=3/2*(n - 3*n**3/16);
  const A4=15/16*(n**2 - n**4/4);
  const A6=35/48*n**3;
  const M=a_bes*(A0*lat_bes - A2*Math.sin(2*lat_bes) + A4*Math.sin(4*lat_bes) - A6*Math.sin(6*lat_bes)) / (1+n);

  const x_gk = M + N_b*sinB*cosB/2*dl**2
    + N_b*sinB*cosB**3/24*(5-t**2+9*n2+4*n2**2)*dl**4;

  const y_gk = N_b*cosB*dl
    + N_b*cosB**3/6*(1-t**2+n2)*dl**3
    + N_b*cosB**5/120*(5-18*t**2+t**4+14*n2-58*n2*t**2)*dl**5;

  // EPSG:31254: y_offset = -5000000
  return { y: Math.round(x_gk - 5000000), x: Math.round(y_gk) };
}

function from31254toLonLat(y31254, x31254) {
  // Inverse: EPSG:31254 -> WGS84
  // Reverse Gauss-Krüger
  const a_bes=6377397.155, f_bes=1/299.1528128;
  const b_bes=a_bes*(1-f_bes);
  const e2=1-(b_bes/a_bes)**2;
  const lon0=10.333333333333*Math.PI/180;
  const n=(a_bes-b_bes)/(a_bes+b_bes);

  const M = y31254 + 5000000;
  const y_gk = x31254;

  // footpoint latitude
  const mu = M / (a_bes * (1 - e2/4 - 3*e2**2/64 - 5*e2**3/256));
  const e1 = (1 - Math.sqrt(1-e2)) / (1 + Math.sqrt(1-e2));
  const lat_fp = mu
    + (3/2*e1 - 27/32*e1**3)*Math.sin(2*mu)
    + (21/16*e1**2 - 55/32*e1**4)*Math.sin(4*mu)
    + 151/96*e1**3*Math.sin(6*mu)
    + 1097/512*e1**4*Math.sin(8*mu);

  const sinFP=Math.sin(lat_fp), cosFP=Math.cos(lat_fp), tanFP=Math.tan(lat_fp);
  const N1=a_bes/Math.sqrt(1-e2*sinFP**2);
  const T1=tanFP**2;
  const C1=e2/(1-e2)*cosFP**2;
  const R1=a_bes*(1-e2)/Math.pow(1-e2*sinFP**2,1.5);
  const D=y_gk/(N1);

  const lat_bes = lat_fp
    - N1*tanFP/R1*(D**2/2 - (5+3*T1+10*C1-4*C1**2-9*e2/(1-e2))*D**4/24);
  const lon_bes = lon0 + (D - (1+2*T1+C1)*D**3/6 + (5-2*C1+28*T1-3*C1**2+8*e2/(1-e2)+24*T1**2)*D**5/120)/cosFP;

  // Bessel->WGS84 (reverse Helmert)
  const dX=-577.326,dY=-90.129,dZ=-463.919;
  const rX=-5.137/206265,rY=-1.474/206265,rZ=-5.297/206265;
  const s=-2.4232/1e6;

  const e2b=1-(b_bes/a_bes)**2;
  const sinB=Math.sin(lat_bes),cosB=Math.cos(lat_bes);
  const N_b=a_bes/Math.sqrt(1-e2b*sinB**2);
  const h=50;
  const Xb=(N_b+h)*cosB*Math.cos(lon_bes);
  const Yb=(N_b+h)*cosB*Math.sin(lon_bes);
  const Zb=(N_b*(1-e2b)+h)*sinB;

  const Xw=(1+s)*(Xb + rZ*Yb - rY*Zb) + dX;
  const Yw=(1+s)*(-rZ*Xb + Yb + rX*Zb) + dY;
  const Zw=(1+s)*(rY*Xb - rX*Yb + Zb) + dZ;

  const a_wgs=6378137.0, f_wgs=1/298.257223563;
  const b_wgs=a_wgs*(1-f_wgs);
  const e2w=1-(b_wgs/a_wgs)**2;
  const p=Math.sqrt(Xw**2+Yw**2);
  let lat_w=Math.atan2(Zw, p*(1-e2w));
  for(let i=0;i<10;i++){
    const Nw=a_wgs/Math.sqrt(1-e2w*Math.sin(lat_w)**2);
    lat_w=Math.atan2(Zw+e2w*Nw*Math.sin(lat_w), p);
  }
  const lon_w=Math.atan2(Yw, Xw);
  return [lat_w*180/Math.PI, lon_w*180/Math.PI];
}

// ── MAP ──────────────────────────────────────────────────────────────────
const map = L.map('map', {
  center: [47.2, 11.4],
  zoom: 9,
  zoomControl: true,
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap © CARTO',
  maxZoom: 19,
}).addTo(map);

// Tirol coverage boundary overlay (approximate)
const tirolBounds = [[46.65, 10.1], [47.75, 12.95]];
L.rectangle(tirolBounds, {
  color: '#4af0a8',
  weight: 1,
  opacity: 0.3,
  fill: false,
  dashArray: '6 4',
}).addTo(map);

// ── RECHTE MAUSTASTE ZUM VERSCHIEBEN ─────────────────────────────────────
let isRightDragging = false;
let lastMousePos = null;

map.getContainer().addEventListener('mousedown', (e) => {
  if (e.button === 2) {               // rechte Maustaste
    e.preventDefault();
    isRightDragging = true;
    lastMousePos = { x: e.clientX, y: e.clientY };
    map.getContainer().style.cursor = 'grabbing';
  }
});

window.addEventListener('mousemove', (e) => {
  if (!isRightDragging) return;
  e.preventDefault();
  const dx = e.clientX - lastMousePos.x;
  const dy = e.clientY - lastMousePos.y;
  if (dx !== 0 || dy !== 0) {
    // Karte in die entgegengesetzte Richtung bewegen (wie bei Google Maps)
    map.panBy([-dx, -dy], { animate: false });
    lastMousePos = { x: e.clientX, y: e.clientY };
  }
});

window.addEventListener('mouseup', (e) => {
  if (isRightDragging) {
    isRightDragging = false;
    map.getContainer().style.cursor = 'crosshair';
  }
});

// Kontextmenü unterdrücken (bereits vorhanden, zur Sicherheit)
map.getContainer().addEventListener('contextmenu', (e) => e.preventDefault());

// ── STATE ─────────────────────────────────────────────────────────────────
let isDrawing = false;
let startLatLng = null;
let currentRect = null;
let selectedBbox = null;
let currentRes = '5m';

// ── DRAW ──────────────────────────────────────────────────────────────────
map.on('mousedown', (e) => {
  if (e.originalEvent.button !== 0) return;
  isDrawing = true;
  startLatLng = e.latlng;
  if (currentRect) { map.removeLayer(currentRect); currentRect = null; }
  map.dragging.disable();
  document.getElementById('status-badge').textContent = 'Zeichnen...';
  document.getElementById('status-badge').className = 'badge active';
});

map.on('mousemove', (e) => {
  if (!isDrawing || !startLatLng) return;
  if (currentRect) map.removeLayer(currentRect);
  currentRect = L.rectangle([startLatLng, e.latlng], {
    color: '#4af0a8',
    weight: 2,
    opacity: 0.9,
    fillColor: '#4af0a8',
    fillOpacity: 0.08,
  }).addTo(map);
});

map.on('mouseup', (e) => {
  if (!isDrawing) return;
  isDrawing = false;
  map.dragging.enable();

  if (!startLatLng) return;
  const end = e.latlng;

  // calc 31254 for all 4 corners
  const p1 = toEPSG31254(startLatLng.lat, startLatLng.lng);
  const p2 = toEPSG31254(end.lat, end.lng);

  const ymin = Math.min(p1.y, p2.y);
  const ymax = Math.max(p1.y, p2.y);
  const xmin = Math.min(p1.x, p2.x);
  const xmax = Math.max(p1.x, p2.x);

  // check if inside coverage
  if (ymax < -5167802 + (-5000000) || ymin > -4706433 + (-5000000)) {
    // rough check
  }

  selectedBbox = { ymin, xmin, ymax, xmax };
  updateUI(ymin, xmin, ymax, xmax);
  document.getElementById('status-badge').textContent = 'Ausgewählt';
});

// ── PRESETS ───────────────────────────────────────────────────────────────
function applyPreset(ymin, xmin, ymax, xmax, name) {
  selectedBbox = { ymin, xmin, ymax, xmax };
  updateUI(ymin, xmin, ymax, xmax);

  // draw on map
  const sw = from31254toLonLat(ymin, xmin);
  const ne = from31254toLonLat(ymax, xmax);

  if (currentRect) map.removeLayer(currentRect);
  currentRect = L.rectangle([[sw[0], sw[1]], [ne[0], ne[1]]], {
    color: '#f0a84a',
    weight: 2,
    opacity: 0.9,
    fillColor: '#f0a84a',
    fillOpacity: 0.08,
  }).addTo(map);

  map.fitBounds([[sw[0], sw[1]], [ne[0], ne[1]]], { padding: [40, 40] });
  document.getElementById('status-badge').textContent = name;
}

// ── UI UPDATE ─────────────────────────────────────────────────────────────
function updateUI(ymin, xmin, ymax, xmax) {
  document.getElementById('val-ymin').textContent = ymin.toLocaleString('de-AT');
  document.getElementById('val-xmin').textContent = xmin.toLocaleString('de-AT');
  document.getElementById('val-ymax').textContent = ymax.toLocaleString('de-AT');
  document.getElementById('val-xmax').textContent = xmax.toLocaleString('de-AT');

  ['coord-ymin','coord-xmin','coord-ymax','coord-xmax'].forEach(id => {
    document.getElementById(id).classList.add('highlight');
  });

  const wM = ymax - ymin;
  const hM = xmax - xmin;
  const areaSqKm = (wM * hM / 1e6).toFixed(1);

  document.getElementById('area-w').textContent = (wM/1000).toFixed(1);
  document.getElementById('area-h').textContent = (hM/1000).toFixed(1);
  document.getElementById('area-total').textContent = areaSqKm;
  document.getElementById('area-info').style.display = 'flex';

  const warn = document.getElementById('size-warning');
  if (parseFloat(areaSqKm) > 25 && currentRes === '50cm') {
    warn.classList.add('show');
  } else {
    warn.classList.remove('show');
  }

  updateCode(ymin, xmin, ymax, xmax);
}

function updateCode(ymin, xmin, ymax, xmax) {
  const coverageName = currentRes === '5m'
    ? 'Gelaendemodell_5m_M28'
    : 'Gelaendemodell_50cm_M28';

  const code = document.getElementById('code-output');
  code.innerHTML = `<span class="comment"># Datenquelle: Land Tirol</span>
<span class="comment"># Auflösung: ${currentRes === '5m' ? '5 Meter' : '50 cm (!)'}</span>

<span class="kw">COVERAGE_NAME</span> = <span class="str">"${coverageName}"</span>

<span class="comment"># BBOX (y_min, x_min, y_max, x_max)</span>
<span class="kw">BBOX</span> = (<span class="num">${ymin}</span>, <span class="num">${xmin}</span>,
       <span class="num">${ymax}</span>, <span class="num">${xmax}</span>)

<span class="comment"># Fläche: ~${((ymax-ymin)/1000).toFixed(1)} × ${((xmax-xmin)/1000).toFixed(1)} km</span><button class="copy-btn" id="copy-btn" onclick="copyCode()">Copy</button>`;
}

function setResolution(res) {
  currentRes = res;
  document.getElementById('res-5m').className = 'res-btn' + (res==='5m' ? ' active' : '');
  document.getElementById('res-50cm').className = 'res-btn' + (res==='50cm' ? ' active' : '');
  if (selectedBbox) {
    const {ymin,xmin,ymax,xmax} = selectedBbox;
    updateUI(ymin, xmin, ymax, xmax);
  }
}

function copyCode() {
  if (!selectedBbox) return;
  const {ymin,xmin,ymax,xmax} = selectedBbox;
  const coverageName = currentRes === '5m' ? 'Gelaendemodell_5m_M28' : 'Gelaendemodell_50cm_M28';
  const text = `# Datenquelle: Land Tirol\nCOVERAGE_NAME = "${coverageName}"\nBBOX = (${ymin}, ${xmin}, ${ymax}, ${xmax})`;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = '✓ Kopiert!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
  });
}

function clearSelection() {
  if (currentRect) { map.removeLayer(currentRect); currentRect = null; }
  selectedBbox = null;
  document.getElementById('val-ymin').textContent = '—';
  document.getElementById('val-xmin').textContent = '—';
  document.getElementById('val-ymax').textContent = '—';
  document.getElementById('val-xmax').textContent = '—';
  ['coord-ymin','coord-xmin','coord-ymax','coord-xmax'].forEach(id => {
    document.getElementById(id).classList.remove('highlight');
  });
  document.getElementById('area-info').style.display = 'none';
  document.getElementById('size-warning').classList.remove('show');
  document.getElementById('code-output').innerHTML = `<span class="comment"># Bereich auswählen um Code</span>\n<span class="comment"># zu generieren...</span>\n\n<span class="placeholder">BBOX = (y_min, x_min,\n        y_max, x_max)</span><button class="copy-btn" id="copy-btn" onclick="copyCode()">Copy</button>`;
  document.getElementById('status-badge').textContent = 'Bereit';
  document.getElementById('status-badge').className = 'badge active';
}

// Disable context menu on map
map.getContainer().addEventListener('contextmenu', e => e.preventDefault());
</script>
</body>
</html>
