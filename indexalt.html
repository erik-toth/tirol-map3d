<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tirol DGM · Bereichsauswahl</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<style>
  :root {
    --bg: #0e1117;
    --surface: #161b27;
    --surface2: #1e2535;
    --border: #2a3349;
    --accent: #4af0a8;
    --accent2: #f0a84a;
    --text: #e8edf5;
    --muted: #6b7a99;
    --danger: #f05a6b;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    z-index: 1000;
  }
  .logo { font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }
  .logo span { color: var(--accent); }
  .subtitle { font-size: 11px; font-weight: 400; color: var(--muted); font-family: 'Space Mono', monospace; letter-spacing: 0.05em; }
  .header-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
  .badge { font-family: 'Space Mono', monospace; font-size: 10px; padding: 3px 8px; border-radius: 3px; background: var(--surface2); border: 1px solid var(--border); color: var(--muted); }
  .badge.active { border-color: var(--accent); color: var(--accent); }

  .main { display: flex; flex: 1; overflow: hidden; }

  #map { flex: 1; background: var(--bg); cursor: crosshair; }
  .leaflet-container { font-family: 'Syne', sans-serif; }
  .leaflet-control-attribution { background: rgba(14,17,23,0.85) !important; color: var(--muted) !important; font-size: 10px; }
  .leaflet-control-attribution a { color: var(--muted) !important; }
  .leaflet-control-zoom a { background: var(--surface) !important; color: var(--text) !important; border-color: var(--border) !important; }
  .leaflet-control-zoom a:hover { background: var(--surface2) !important; color: var(--accent) !important; }

  .sidebar { width: 320px; background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; }
  .panel { padding: 18px; border-bottom: 1px solid var(--border); }
  .panel-title { font-size: 10px; font-weight: 600; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 14px; font-family: 'Space Mono', monospace; }

  .instruction { display: flex; align-items: flex-start; gap: 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-size: 13px; color: var(--muted); line-height: 1.5; }
  .instruction .icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }

  .coord-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
  .coord-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; }
  .coord-item.highlight { border-color: var(--accent); }
  .coord-label { font-size: 10px; font-family: 'Space Mono', monospace; color: var(--muted); margin-bottom: 4px; letter-spacing: 0.05em; }
  .coord-value { font-size: 14px; font-family: 'Space Mono', monospace; font-weight: 700; color: var(--text); }
  .coord-item.highlight .coord-value { color: var(--accent); }
  .coord-empty { color: var(--muted); font-size: 12px; font-family: 'Space Mono', monospace; opacity: 0.5; }

  .area-info { display: flex; gap: 8px; margin-top: 4px; }
  .area-chip { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 8px; text-align: center; }
  .area-chip .val { font-size: 16px; font-weight: 700; font-family: 'Space Mono', monospace; color: var(--accent2); }
  .area-chip .unit { font-size: 10px; color: var(--muted); margin-top: 2px; }

  .code-block { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 14px; font-family: 'Space Mono', monospace; font-size: 12px; line-height: 1.7; color: #a8c4e8; position: relative; overflow-x: auto; white-space: pre; }
  .code-block .comment { color: #4a6280; }
  .code-block .kw { color: #c792ea; }
  .code-block .str { color: #c3e88d; }
  .code-block .num { color: var(--accent); }
  .code-block .placeholder { color: var(--muted); font-style: italic; }
  .copy-btn { position: absolute; top: 8px; right: 8px; background: var(--surface); border: 1px solid var(--border); color: var(--muted); font-family: 'Space Mono', monospace; font-size: 10px; padding: 4px 8px; border-radius: 4px; cursor: pointer; transition: all 0.15s; }
  .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
  .copy-btn.copied { border-color: var(--accent); color: var(--accent); }

  .res-toggle { display: flex; gap: 6px; }
  .res-btn { flex: 1; padding: 8px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--muted); font-family: 'Space Mono', monospace; font-size: 11px; cursor: pointer; transition: all 0.15s; text-align: center; }
  .res-btn:hover { border-color: var(--accent); color: var(--text); }
  .res-btn.active { border-color: var(--accent); background: rgba(74,240,168,0.08); color: var(--accent); }

  .preset-list { display: flex; flex-direction: column; gap: 6px; }
  .preset-btn { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.15s; text-align: left; width: 100%; }
  .preset-btn:hover { border-color: var(--accent2); }
  .preset-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent2); flex-shrink: 0; }
  .preset-name { font-size: 13px; font-weight: 600; color: var(--text); }
  .preset-sub { font-size: 10px; font-family: 'Space Mono', monospace; color: var(--muted); margin-top: 1px; }

  .clear-btn { width: 100%; padding: 10px; background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--danger); font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; letter-spacing: 0.03em; }
  .clear-btn:hover { background: rgba(240,90,107,0.1); border-color: var(--danger); }

  .warning { background: rgba(240,168,74,0.08); border: 1px solid rgba(240,168,74,0.3); border-radius: 6px; padding: 10px 12px; font-size: 12px; color: var(--accent2); line-height: 1.5; display: none; }
  .warning.show { display: block; }

  /* ── GENERATE PANEL ── */
  .gen-options { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }

  .opt-row { display: flex; gap: 6px; }
  .opt-label { font-size: 10px; font-family: 'Space Mono', monospace; color: var(--muted); margin-bottom: 6px; letter-spacing: 0.05em; display: block; }

  .opt-group { flex: 1; }

  .tog-btn { flex: 1; padding: 7px 6px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--muted); font-family: 'Space Mono', monospace; font-size: 11px; cursor: pointer; transition: all 0.15s; text-align: center; }
  .tog-btn:hover { border-color: var(--accent); color: var(--text); }
  .tog-btn.active { border-color: var(--accent); background: rgba(74,240,168,0.08); color: var(--accent); }
  .tog-btn.active-orange { border-color: var(--accent2); background: rgba(240,168,74,0.08); color: var(--accent2); }

  .num-input { width: 100%; padding: 7px 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'Space Mono', monospace; font-size: 12px; }
  .num-input:focus { outline: none; border-color: var(--accent); }

  .gen-btn { width: 100%; padding: 13px; background: linear-gradient(135deg, rgba(74,240,168,0.15), rgba(74,240,168,0.08)); border: 1px solid var(--accent); border-radius: 8px; color: var(--accent); font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 800; cursor: pointer; transition: all 0.2s; letter-spacing: 0.05em; }
  .gen-btn:hover:not(:disabled) { background: linear-gradient(135deg, rgba(74,240,168,0.25), rgba(74,240,168,0.15)); box-shadow: 0 0 20px rgba(74,240,168,0.15); }
  .gen-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .gen-btn.loading { animation: pulse 1.5s infinite; }

  @keyframes pulse { 0%,100% { opacity: 0.6; } 50% { opacity: 1; } }

  /* ── LOG BOX ── */
  .log-box { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); max-height: 140px; overflow-y: auto; line-height: 1.7; display: none; }
  .log-box.show { display: block; }
  .log-line { color: var(--muted); }
  .log-line.ok { color: var(--accent); }
  .log-line.err { color: var(--danger); }

  /* ── DOWNLOAD BUTTONS ── */
  .dl-list { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
  .dl-btn { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: rgba(74,240,168,0.06); border: 1px solid rgba(74,240,168,0.3); border-radius: 6px; cursor: pointer; text-decoration: none; transition: all 0.15s; }
  .dl-btn:hover { background: rgba(74,240,168,0.12); border-color: var(--accent); }
  .dl-btn-name { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--accent); }
  .dl-btn-size { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--muted); }

  .sidebar::-webkit-scrollbar { width: 4px; }
  .sidebar::-webkit-scrollbar-track { background: transparent; }
  .sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>

<header>
  <div>
    <div class="logo">Tirol <span>DGM</span> Selector</div>
    <div class="subtitle">WCS · EPSG:31254 · Land Tirol</div>
  </div>
  <div class="header-right">
    <div class="badge active" id="status-badge">Bereit</div>
    <div class="badge">5m / 50cm Auflösung</div>
  </div>
</header>

<div class="main">
  <div id="map"></div>

  <div class="sidebar">

    <!-- Instruction -->
    <div class="panel">
      <div class="panel-title">Anleitung</div>
      <div class="instruction">
        <span class="icon">⬛</span>
        <span>Klicke und ziehe auf der Karte um einen Bereich auszuwählen. Die BBOX-Koordinaten werden automatisch in <strong>EPSG:31254</strong> umgerechnet.</span>
      </div>
    </div>

    <!-- Coordinates -->
    <div class="panel">
      <div class="panel-title">Bounding Box · EPSG:31254</div>
      <div class="coord-grid">
        <div class="coord-item" id="coord-ymin">
          <div class="coord-label">y_min</div>
          <div class="coord-value coord-empty" id="val-ymin">—</div>
        </div>
        <div class="coord-item" id="coord-xmin">
          <div class="coord-label">x_min</div>
          <div class="coord-value coord-empty" id="val-xmin">—</div>
        </div>
        <div class="coord-item" id="coord-ymax">
          <div class="coord-label">y_max</div>
          <div class="coord-value coord-empty" id="val-ymax">—</div>
        </div>
        <div class="coord-item" id="coord-xmax">
          <div class="coord-label">x_max</div>
          <div class="coord-value coord-empty" id="val-xmax">—</div>
        </div>
      </div>
      <div class="area-info" id="area-info" style="display:none">
        <div class="area-chip">
          <div class="val" id="area-w">—</div>
          <div class="unit">Breite (km)</div>
        </div>
        <div class="area-chip">
          <div class="val" id="area-h">—</div>
          <div class="unit">Höhe (km)</div>
        </div>
        <div class="area-chip">
          <div class="val" id="area-total">—</div>
          <div class="unit">Fläche (km²)</div>
        </div>
      </div>
      <div class="warning" id="size-warning">
        ⚠ Großer Bereich! Bei 50cm Auflösung entstehen sehr große Dateien.
      </div>
    </div>

    <!-- Resolution -->
    <div class="panel">
      <div class="panel-title">Auflösung</div>
      <div class="res-toggle">
        <div class="res-btn active" id="res-5m" onclick="setResolution('5m')">
          <div>5m</div>
          <div style="font-size:9px;color:var(--muted);margin-top:2px">Standard</div>
        </div>
        <div class="res-btn" id="res-50cm" onclick="setResolution('50cm')">
          <div>50cm</div>
          <div style="font-size:9px;color:var(--muted);margin-top:2px">Sehr groß!</div>
        </div>
      </div>
    </div>

    <!-- Python Code -->
    <div class="panel">
      <div class="panel-title">Python Code</div>
      <div class="code-block" id="code-output">
<span class="comment"># Bereich auswählen um Code</span>
<span class="comment"># zu generieren...</span>

<span class="placeholder">BBOX = (y_min, x_min,
        y_max, x_max)</span>
        <button class="copy-btn" id="copy-btn" onclick="copyCode()">Copy</button>
      </div>
    </div>

    <!-- ── GENERATE PANEL ── -->
    <div class="panel">
      <div class="panel-title">3D-Datei generieren</div>

      <div class="gen-options">

        <!-- Downsampling -->
        <div class="opt-group">
          <span class="opt-label">Downsampling-Faktor</span>
          <div class="opt-row" id="ds-toggle">
            <button class="tog-btn active" data-val="1" onclick="setDS(this)">1× (exakt)</button>
            <button class="tog-btn" data-val="2" onclick="setDS(this)">2×</button>
            <button class="tog-btn" data-val="4" onclick="setDS(this)">4× (emp.)</button>
            <button class="tog-btn" data-val="8" onclick="setDS(this)">8×</button>
          </div>
        </div>

        <!-- Zielgröße -->
        <div class="opt-group">
          <span class="opt-label">Seitenlänge Ausgabe (mm)</span>
          <input class="num-input" type="number" id="target-mm" value="100" min="10" max="1000" step="10">
        </div>

        <!-- Geschlossen -->
        <div class="opt-group">
          <span class="opt-label">Volumen</span>
          <div class="opt-row">
            <button class="tog-btn active" id="closed-no" onclick="setClosed(false)">Offen</button>
            <button class="tog-btn" id="closed-yes" onclick="setClosed(true)">Geschlossen</button>
          </div>
        </div>

        <!-- Format -->
        <div class="opt-group">
          <span class="opt-label">Format</span>
          <div class="opt-row">
            <button class="tog-btn active" data-fmt="stl" onclick="setFmt(this)">STL</button>
            <button class="tog-btn" data-fmt="obj" onclick="setFmt(this)">OBJ</button>
            <button class="tog-btn" data-fmt="both" onclick="setFmt(this)">Beide</button>
          </div>
        </div>

      </div>

      <button class="gen-btn" id="gen-btn" onclick="startGenerate()" disabled>
        ▶ GENERIEREN
      </button>

      <!-- Log -->
      <div class="log-box" id="log-box"></div>

      <!-- Downloads -->
      <div class="dl-list" id="dl-list"></div>
    </div>

    <!-- Presets -->
    <div class="panel">
      <div class="panel-title">Schnellauswahl</div>
      <div class="preset-list">
        <button class="preset-btn" onclick="applyPreset(212983,23647,218983,29647,'Kaunertal Start')">
          <div class="preset-dot"></div>
          <div>
            <div class="preset-name">Kaunertal Start</div>
            <div class="preset-sub">~6×6 km · Standard-Beispiel</div>
          </div>
        </button>
        <button class="preset-btn" onclick="applyPreset(230000,74000,236000,80000,'Innsbruck Altstadt')">
          <div class="preset-dot"></div>
          <div>
            <div class="preset-name">Innsbruck Altstadt</div>
            <div class="preset-sub">~6×6 km</div>
          </div>
        </button>
        <button class="preset-btn" onclick="applyPreset(234000,60000,244000,70000,'Innsbruck Region')">
          <div class="preset-dot"></div>
          <div>
            <div class="preset-name">Innsbruck Region</div>
            <div class="preset-sub">~10×10 km</div>
          </div>
        </button>
        <button class="preset-btn" onclick="applyPreset(195000,20000,210000,35000,'Kaunertal Gesamt')">
          <div class="preset-dot"></div>
          <div>
            <div class="preset-name">Kaunertal Gesamt</div>
            <div class="preset-sub">~15×15 km</div>
          </div>
        </button>
        <button class="preset-btn" onclick="applyPreset(165000,150000,175000,160000,'Kitzbühel')">
          <div class="preset-dot"></div>
          <div>
            <div class="preset-name">Kitzbühel</div>
            <div class="preset-sub">~10×10 km</div>
          </div>
        </button>
      </div>
    </div>

    <!-- Clear -->
    <div class="panel">
      <button class="clear-btn" onclick="clearSelection()">✕ Auswahl löschen</button>
    </div>

  </div>
</div>

<script>
// ── PROJ ─────────────────────────────────────────────────────────────────
function toEPSG31254(lat, lon) {
  const dX=577.326, dY=90.129, dZ=463.919;
  const rX=5.137/206265, rY=1.474/206265, rZ=5.297/206265, s=2.4232/1e6;
  const a_wgs=6378137.0, f_wgs=1/298.257223563;
  const b_wgs=a_wgs*(1-f_wgs), e2_wgs=1-(b_wgs/a_wgs)**2;
  const latR=lat*Math.PI/180, lonR=lon*Math.PI/180;
  const sinLat=Math.sin(latR), cosLat=Math.cos(latR), sinLon=Math.sin(lonR), cosLon=Math.cos(lonR);
  const N_wgs=a_wgs/Math.sqrt(1-e2_wgs*sinLat**2), h=50;
  const X=(N_wgs+h)*cosLat*cosLon, Y=(N_wgs+h)*cosLat*sinLon, Z=(N_wgs*(1-e2_wgs)+h)*sinLat;
  const Xb=(1+s)*(X + rZ*Y - rY*Z) + dX;
  const Yb=(1+s)*(-rZ*X + Y + rX*Z) + dY;
  const Zb=(1+s)*(rY*X - rX*Y + Z) + dZ;
  const a_bes=6377397.155, f_bes=1/299.1528128;
  const b_bes=a_bes*(1-f_bes), e2_bes=1-(b_bes/a_bes)**2;
  const p=Math.sqrt(Xb**2+Yb**2);
  let lat_bes=Math.atan2(Zb, p*(1-e2_bes));
  for(let i=0;i<10;i++){const N_=a_bes/Math.sqrt(1-e2_bes*Math.sin(lat_bes)**2);lat_bes=Math.atan2(Zb+e2_bes*N_*Math.sin(lat_bes), p);}
  const lon_bes=Math.atan2(Yb, Xb);
  const lon0=10.333333333333*Math.PI/180, dlon=lon_bes-lon0;
  const sinB=Math.sin(lat_bes), cosB=Math.cos(lat_bes), tanB=Math.tan(lat_bes);
  const N_b=a_bes/Math.sqrt(1-e2_bes*sinB**2), e2_=e2_bes*cosB**2/(1-e2_bes), t=tanB, n2=e2_, dl=dlon;
  const n=(a_bes-b_bes)/(a_bes+b_bes);
  const A0=1 - n**2/4 - 3*n**4/64, A2=3/2*(n - 3*n**3/16), A4=15/16*(n**2 - n**4/4), A6=35/48*n**3;
  const M=a_bes*(A0*lat_bes - A2*Math.sin(2*lat_bes) + A4*Math.sin(4*lat_bes) - A6*Math.sin(6*lat_bes)) / (1+n);
  const x_gk = M + N_b*sinB*cosB/2*dl**2 + N_b*sinB*cosB**3/24*(5-t**2+9*n2+4*n2**2)*dl**4;
  const y_gk = N_b*cosB*dl + N_b*cosB**3/6*(1-t**2+n2)*dl**3 + N_b*cosB**5/120*(5-18*t**2+t**4+14*n2-58*n2*t**2)*dl**5;
  return { y: Math.round(x_gk - 5000000), x: Math.round(y_gk) };
}

function from31254toLonLat(y31254, x31254) {
  const a_bes=6377397.155, f_bes=1/299.1528128;
  const b_bes=a_bes*(1-f_bes), e2=1-(b_bes/a_bes)**2;
  const lon0=10.333333333333*Math.PI/180;
  const n=(a_bes-b_bes)/(a_bes+b_bes);
  const M = y31254 + 5000000, y_gk = x31254;
  const mu = M / (a_bes * (1 - e2/4 - 3*e2**2/64 - 5*e2**3/256));
  const e1 = (1 - Math.sqrt(1-e2)) / (1 + Math.sqrt(1-e2));
  const lat_fp = mu + (3/2*e1 - 27/32*e1**3)*Math.sin(2*mu) + (21/16*e1**2 - 55/32*e1**4)*Math.sin(4*mu) + 151/96*e1**3*Math.sin(6*mu) + 1097/512*e1**4*Math.sin(8*mu);
  const sinFP=Math.sin(lat_fp), cosFP=Math.cos(lat_fp), tanFP=Math.tan(lat_fp);
  const N1=a_bes/Math.sqrt(1-e2*sinFP**2), T1=tanFP**2, C1=e2/(1-e2)*cosFP**2;
  const R1=a_bes*(1-e2)/Math.pow(1-e2*sinFP**2,1.5), D=y_gk/(N1);
  const lat_bes = lat_fp - N1*tanFP/R1*(D**2/2 - (5+3*T1+10*C1-4*C1**2-9*e2/(1-e2))*D**4/24);
  const lon_bes = lon0 + (D - (1+2*T1+C1)*D**3/6 + (5-2*C1+28*T1-3*C1**2+8*e2/(1-e2)+24*T1**2)*D**5/120)/cosFP;
  const dX=-577.326,dY=-90.129,dZ=-463.919, rX=-5.137/206265,rY=-1.474/206265,rZ=-5.297/206265, s=-2.4232/1e6;
  const e2b=1-(b_bes/a_bes)**2, sinB=Math.sin(lat_bes),cosB=Math.cos(lat_bes);
  const N_b=a_bes/Math.sqrt(1-e2b*sinB**2), h=50;
  const Xb=(N_b+h)*cosB*Math.cos(lon_bes), Yb=(N_b+h)*cosB*Math.sin(lon_bes), Zb=(N_b*(1-e2b)+h)*sinB;
  const Xw=(1+s)*(Xb + rZ*Yb - rY*Zb) + dX, Yw=(1+s)*(-rZ*Xb + Yb + rX*Zb) + dY, Zw=(1+s)*(rY*Xb - rX*Yb + Zb) + dZ;
  const a_wgs=6378137.0, f_wgs=1/298.257223563, b_wgs=a_wgs*(1-f_wgs), e2w=1-(b_wgs/a_wgs)**2;
  const pp=Math.sqrt(Xw**2+Yw**2);
  let lat_w=Math.atan2(Zw, pp*(1-e2w));
  for(let i=0;i<10;i++){const Nw=a_wgs/Math.sqrt(1-e2w*Math.sin(lat_w)**2);lat_w=Math.atan2(Zw+e2w*Nw*Math.sin(lat_w), pp);}
  return [lat_w*180/Math.PI, Math.atan2(Yw, Xw)*180/Math.PI];
}

// ── MAP ───────────────────────────────────────────────────────────────────
const map = L.map('map', { center: [47.2, 11.4], zoom: 9, zoomControl: true });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap', maxZoom: 19 }).addTo(map);
L.rectangle([[46.65, 10.1], [47.75, 12.95]], { color: '#4af0a8', weight: 1, opacity: 0.3, fill: false, dashArray: '6 4' }).addTo(map);

// right-click drag
let isRightDragging = false, lastMousePos = null;
map.getContainer().addEventListener('mousedown', e => { if (e.button === 2) { e.preventDefault(); isRightDragging = true; lastMousePos = { x: e.clientX, y: e.clientY }; map.getContainer().style.cursor = 'grabbing'; } });
window.addEventListener('mousemove', e => { if (!isRightDragging) return; e.preventDefault(); const dx = e.clientX - lastMousePos.x, dy = e.clientY - lastMousePos.y; if (dx||dy) { map.panBy([-dx,-dy],{animate:false}); lastMousePos={x:e.clientX,y:e.clientY}; } });
window.addEventListener('mouseup', () => { if(isRightDragging){isRightDragging=false;map.getContainer().style.cursor='crosshair';} });
map.getContainer().addEventListener('contextmenu', e => e.preventDefault());

// ── STATE ─────────────────────────────────────────────────────────────────
let isDrawing=false, startLatLng=null, currentRect=null, selectedBbox=null;
let currentRes='5m', dsVal=1, closedBody=false, fmtVal='stl';

// ── DRAW ──────────────────────────────────────────────────────────────────
map.on('mousedown', e => {
  if (e.originalEvent.button !== 0) return;
  isDrawing=true; startLatLng=e.latlng;
  if (currentRect) { map.removeLayer(currentRect); currentRect=null; }
  map.dragging.disable();
  document.getElementById('status-badge').textContent='Zeichnen...';
});
map.on('mousemove', e => {
  if (!isDrawing||!startLatLng) return;
  if (currentRect) map.removeLayer(currentRect);
  currentRect = L.rectangle([startLatLng, e.latlng], { color:'#4af0a8', weight:2, opacity:0.9, fillColor:'#4af0a8', fillOpacity:0.08 }).addTo(map);
});
map.on('mouseup', e => {
  if (!isDrawing) return;
  isDrawing=false; map.dragging.enable();
  if (!startLatLng) return;
  const p1=toEPSG31254(startLatLng.lat,startLatLng.lng), p2=toEPSG31254(e.latlng.lat,e.latlng.lng);
  const ymin=Math.min(p1.y,p2.y), ymax=Math.max(p1.y,p2.y), xmin=Math.min(p1.x,p2.x), xmax=Math.max(p1.x,p2.x);
  selectedBbox={ymin,xmin,ymax,xmax};
  updateUI(ymin,xmin,ymax,xmax);
  document.getElementById('status-badge').textContent='Ausgewählt';
});

// ── PRESETS ───────────────────────────────────────────────────────────────
function applyPreset(ymin,xmin,ymax,xmax,name) {
  selectedBbox={ymin,xmin,ymax,xmax};
  updateUI(ymin,xmin,ymax,xmax);
  const sw=from31254toLonLat(ymin,xmin), ne=from31254toLonLat(ymax,xmax);
  if (currentRect) map.removeLayer(currentRect);
  currentRect = L.rectangle([[sw[0],sw[1]],[ne[0],ne[1]]], { color:'#f0a84a', weight:2, opacity:0.9, fillColor:'#f0a84a', fillOpacity:0.08 }).addTo(map);
  map.fitBounds([[sw[0],sw[1]],[ne[0],ne[1]]],{padding:[40,40]});
  document.getElementById('status-badge').textContent=name;
}

// ── UI UPDATE ─────────────────────────────────────────────────────────────
function updateUI(ymin,xmin,ymax,xmax) {
  document.getElementById('val-ymin').textContent=ymin.toLocaleString('de-AT');
  document.getElementById('val-xmin').textContent=xmin.toLocaleString('de-AT');
  document.getElementById('val-ymax').textContent=ymax.toLocaleString('de-AT');
  document.getElementById('val-xmax').textContent=xmax.toLocaleString('de-AT');
  ['coord-ymin','coord-xmin','coord-ymax','coord-xmax'].forEach(id=>document.getElementById(id).classList.add('highlight'));
  const wM=ymax-ymin, hM=xmax-xmin, areaSqKm=(wM*hM/1e6).toFixed(1);
  document.getElementById('area-w').textContent=(wM/1000).toFixed(1);
  document.getElementById('area-h').textContent=(hM/1000).toFixed(1);
  document.getElementById('area-total').textContent=areaSqKm;
  document.getElementById('area-info').style.display='flex';
  const warn=document.getElementById('size-warning');
  if(parseFloat(areaSqKm)>25&&currentRes==='50cm') warn.classList.add('show'); else warn.classList.remove('show');
  updateCode(ymin,xmin,ymax,xmax);
  document.getElementById('gen-btn').disabled=false;
}

function updateCode(ymin,xmin,ymax,xmax) {
  const coverageName=currentRes==='5m'?'Gelaendemodell_5m_M28':'Gelaendemodell_50cm_M28';
  document.getElementById('code-output').innerHTML=`<span class="comment"># Datenquelle: Land Tirol</span>
<span class="comment"># Auflösung: ${currentRes==='5m'?'5 Meter':'50 cm (!)'}</span>

<span class="kw">COVERAGE_NAME</span> = <span class="str">"${coverageName}"</span>

<span class="comment"># BBOX (y_min, x_min, y_max, x_max)</span>
<span class="kw">BBOX</span> = (<span class="num">${ymin}</span>, <span class="num">${xmin}</span>,
       <span class="num">${ymax}</span>, <span class="num">${xmax}</span>)

<span class="comment"># Fläche: ~${((ymax-ymin)/1000).toFixed(1)} × ${((xmax-xmin)/1000).toFixed(1)} km</span><button class="copy-btn" id="copy-btn" onclick="copyCode()">Copy</button>`;
}

function setResolution(res) {
  currentRes=res;
  document.getElementById('res-5m').className='res-btn'+(res==='5m'?' active':'');
  document.getElementById('res-50cm').className='res-btn'+(res==='50cm'?' active':'');
  if(selectedBbox){const{ymin,xmin,ymax,xmax}=selectedBbox;updateUI(ymin,xmin,ymax,xmax);}
}

function copyCode() {
  if(!selectedBbox) return;
  const{ymin,xmin,ymax,xmax}=selectedBbox;
  const cn=currentRes==='5m'?'Gelaendemodell_5m_M28':'Gelaendemodell_50cm_M28';
  const text=`# Datenquelle: Land Tirol\nCOVERAGE_NAME = "${cn}"\nBBOX = (${ymin}, ${xmin}, ${ymax}, ${xmax})`;
  navigator.clipboard.writeText(text).then(()=>{
    const btn=document.getElementById('copy-btn');
    btn.textContent='✓ Kopiert!'; btn.classList.add('copied');
    setTimeout(()=>{btn.textContent='Copy';btn.classList.remove('copied');},2000);
  });
}

function clearSelection() {
  if(currentRect){map.removeLayer(currentRect);currentRect=null;}
  selectedBbox=null;
  document.getElementById('val-ymin').textContent='—';
  document.getElementById('val-xmin').textContent='—';
  document.getElementById('val-ymax').textContent='—';
  document.getElementById('val-xmax').textContent='—';
  ['coord-ymin','coord-xmin','coord-ymax','coord-xmax'].forEach(id=>document.getElementById(id).classList.remove('highlight'));
  document.getElementById('area-info').style.display='none';
  document.getElementById('size-warning').classList.remove('show');
  document.getElementById('code-output').innerHTML=`<span class="comment"># Bereich auswählen um Code</span>\n<span class="comment"># zu generieren...</span>\n\n<span class="placeholder">BBOX = (y_min, x_min,\n        y_max, x_max)</span><button class="copy-btn" id="copy-btn" onclick="copyCode()">Copy</button>`;
  document.getElementById('status-badge').textContent='Bereit';
  document.getElementById('status-badge').className='badge active';
  document.getElementById('gen-btn').disabled=true;
  document.getElementById('log-box').classList.remove('show');
  document.getElementById('dl-list').innerHTML='';
}

// ── GENERATE OPTIONS ──────────────────────────────────────────────────────
function setDS(btn) {
  document.querySelectorAll('#ds-toggle .tog-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  dsVal=parseInt(btn.dataset.val);
}

function setClosed(v) {
  closedBody=v;
  document.getElementById('closed-no').className='tog-btn'+(v?'':' active');
  document.getElementById('closed-yes').className='tog-btn'+(v?' active':'');
}

function setFmt(btn) {
  document.querySelectorAll('[data-fmt]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  fmtVal=btn.dataset.fmt;
}

// ── GENERATE ──────────────────────────────────────────────────────────────
const SERVER = 'http://localhost:5000';
let pollTimer = null;

function startGenerate() {
  if (!selectedBbox) return;
  const {ymin,xmin,ymax,xmax} = selectedBbox;
  const coverageName = currentRes==='5m'?'Gelaendemodell_5m_M28':'Gelaendemodell_50cm_M28';
  const targetMm = parseFloat(document.getElementById('target-mm').value) || 100;

  const genBtn = document.getElementById('gen-btn');
  const logBox = document.getElementById('log-box');
  const dlList = document.getElementById('dl-list');

  genBtn.disabled = true;
  genBtn.classList.add('loading');
  genBtn.textContent = '⏳ Wird verarbeitet...';
  logBox.innerHTML = '';
  logBox.classList.add('show');
  dlList.innerHTML = '';

  addLog('Verbinde mit Server...');

  fetch(`${SERVER}/generate`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      bbox: [ymin, xmin, ymax, xmax],
      coverage_name: coverageName,
      downsample: dsVal,
      closed_body: closedBody,
      target_mm: targetMm,
      format: fmtVal,
    })
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) throw new Error(data.error);
    addLog(`Job gestartet: ${data.job_id.slice(0,8)}...`);
    pollJob(data.job_id);
  })
  .catch(err => {
    addLog('ERROR: ' + err.message, true);
    addLog('Läuft der Server? python server.py', true);
    resetGenBtn();
  });
}

function pollJob(jobId) {
  pollTimer = setInterval(() => {
    fetch(`${SERVER}/status/${jobId}`)
      .then(r => r.json())
      .then(data => {
        // sync log lines
        const logBox = document.getElementById('log-box');
        const existing = logBox.children.length;
        const allLogs = data.log || [];
        for (let i = existing; i < allLogs.length; i++) {
          addLog(allLogs[i]);
        }

        if (data.status === 'done') {
          clearInterval(pollTimer);
          addLog('✓ Fertig!', false, true);
          showDownloads(data.files);
          resetGenBtn('✓ Fertig – Neu generieren');
        } else if (data.status === 'error') {
          clearInterval(pollTimer);
          addLog('ERROR: ' + data.error, true);
          resetGenBtn();
        }
      })
      .catch(() => {});
  }, 1000);
}

function addLog(msg, isErr=false, isOk=false) {
  const logBox = document.getElementById('log-box');
  const line = document.createElement('div');
  line.className = 'log-line' + (isErr?' err':'') + (isOk?' ok':'');
  line.textContent = msg;
  logBox.appendChild(line);
  logBox.scrollTop = logBox.scrollHeight;
}

function showDownloads(files) {
  const dlList = document.getElementById('dl-list');
  dlList.innerHTML = '';
  (files||[]).forEach(f => {
    const a = document.createElement('a');
    a.className = 'dl-btn';
    a.href = `${SERVER}/download/${f.name}`;
    a.download = f.name;
    a.innerHTML = `<span class="dl-btn-name">⬇ ${f.name}</span><span class="dl-btn-size">${f.size_mb} MB</span>`;
    dlList.appendChild(a);
  });
}

function resetGenBtn(label='▶ GENERIEREN') {
  const genBtn = document.getElementById('gen-btn');
  genBtn.disabled = false;
  genBtn.classList.remove('loading');
  genBtn.textContent = label;
}
</script>
</body>
</html>
