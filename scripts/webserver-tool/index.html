<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tirol DGM ¬∑ 3D‚ÄëGenerator (auf Tirol begrenzt)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<style>
  :root {
    --bg: #0e1117;
    --surface: #161b27;
    --surface2: #1e2535;
    --border: #2a3349;
    --accent: #4af0a8;
    --accent2: #f0a84a;
    --text: #e8edf5;
    --muted: #6b7a99;
    --danger: #f05a6b;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    z-index: 1000;
  }
  .logo { font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }
  .logo span { color: var(--accent); }
  .subtitle { font-size: 11px; font-weight: 400; color: var(--muted); font-family: 'Space Mono', monospace; letter-spacing: 0.05em; }
  .header-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
  .badge { font-family: 'Space Mono', monospace; font-size: 10px; padding: 3px 8px; border-radius: 3px; background: var(--surface2); border: 1px solid var(--border); color: var(--muted); }
  .badge.active { border-color: var(--accent); color: var(--accent); }
  .badge.warning { border-color: var(--accent2); color: var(--accent2); }

  .main { display: flex; flex: 1; overflow: hidden; }

  #map { flex: 1; background: var(--bg); cursor: crosshair; }
  .leaflet-container { font-family: 'Syne', sans-serif; }
  .leaflet-control-attribution { background: rgba(14,17,23,0.85) !important; color: var(--muted) !important; font-size: 10px; }
  .leaflet-control-attribution a { color: var(--muted) !important; }
  .leaflet-control-zoom a { background: var(--surface) !important; color: var(--text) !important; border-color: var(--border) !important; }
  .leaflet-control-zoom a:hover { background: var(--surface2) !important; color: var(--accent) !important; }

  .sidebar { width: 320px; background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; }
  .panel { padding: 18px; border-bottom: 1px solid var(--border); }
  .panel-title { font-size: 10px; font-weight: 600; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 14px; font-family: 'Space Mono', monospace; }

  .instruction { display: flex; align-items: flex-start; gap: 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-size: 13px; color: var(--muted); line-height: 1.5; }
  .instruction .icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }

  .coord-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
  .coord-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; }
  .coord-item.highlight { border-color: var(--accent); }
  .coord-label { font-size: 10px; font-family: 'Space Mono', monospace; color: var(--muted); margin-bottom: 4px; letter-spacing: 0.05em; }
  .coord-value { font-size: 14px; font-family: 'Space Mono', monospace; font-weight: 700; color: var(--text); }
  .coord-item.highlight .coord-value { color: var(--accent); }
  .coord-empty { color: var(--muted); font-size: 12px; font-family: 'Space Mono', monospace; opacity: 0.5; }

  .area-info { display: flex; gap: 8px; margin-top: 4px; }
  .area-chip { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 8px; text-align: center; }
  .area-chip .val { font-size: 16px; font-weight: 700; font-family: 'Space Mono', monospace; color: var(--accent2); }
  .area-chip .unit { font-size: 10px; color: var(--muted); margin-top: 2px; }

  .res-toggle { display: flex; gap: 6px; }
  .res-btn { flex: 1; padding: 8px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--muted); font-family: 'Space Mono', monospace; font-size: 11px; cursor: pointer; transition: all 0.15s; text-align: center; }
  .res-btn:hover { border-color: var(--accent); color: var(--text); }
  .res-btn.active { border-color: var(--accent); background: rgba(74,240,168,0.08); color: var(--accent); }

  .clear-btn { width: 100%; padding: 10px; background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--danger); font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; letter-spacing: 0.03em; }
  .clear-btn:hover { background: rgba(240,90,107,0.1); border-color: var(--danger); }

  .warning { background: rgba(240,168,74,0.08); border: 1px solid rgba(240,168,74,0.3); border-radius: 6px; padding: 10px 12px; font-size: 12px; color: var(--accent2); line-height: 1.5; display: none; }
  .warning.show { display: block; }

  /* GENERATE PANEL */
  .gen-options { display: flex; flex-direction: column; gap: 12px; margin-bottom: 12px; }
  .opt-row { display: flex; gap: 6px; align-items: center; }
  .opt-label { font-size: 10px; font-family: 'Space Mono', monospace; color: var(--muted); margin-bottom: 6px; letter-spacing: 0.05em; display: block; }
  .opt-group {  }
  .num-input { width: 100%; padding: 7px 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'Space Mono', monospace; font-size: 12px; }
  .num-input:focus { outline: none; border-color: var(--accent); }
  .tog-btn { flex: 1; padding: 7px 6px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--muted); font-family: 'Space Mono', monospace; font-size: 11px; cursor: pointer; transition: all 0.15s; text-align: center; }
  .tog-btn:hover { border-color: var(--accent); color: var(--text); }
  .tog-btn.active { border-color: var(--accent); background: rgba(74,240,168,0.08); color: var(--accent); }

  .gen-btn { width: 100%; padding: 13px; background: linear-gradient(135deg, rgba(74,240,168,0.15), rgba(74,240,168,0.08)); border: 1px solid var(--accent); border-radius: 8px; color: var(--accent); font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 800; cursor: pointer; transition: all 0.2s; letter-spacing: 0.05em; margin-top: 6px; }
  .gen-btn:hover:not(:disabled) { background: linear-gradient(135deg, rgba(74,240,168,0.25), rgba(74,240,168,0.15)); box-shadow: 0 0 20px rgba(74,240,168,0.15); }
  .gen-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .gen-btn.loading { animation: pulse 1.5s infinite; }

  @keyframes pulse { 0%,100% { opacity: 0.6; } 50% { opacity: 1; } }

  .log-box { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); max-height: 140px; overflow-y: auto; line-height: 1.7; display: none; margin-top: 10px; }
  .log-box.show { display: block; }
  .log-line { color: var(--muted); }
  .log-line.ok { color: var(--accent); }
  .log-line.err { color: var(--danger); }

  .dl-list { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
  .dl-btn { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: rgba(74,240,168,0.06); border: 1px solid rgba(74,240,168,0.3); border-radius: 6px; cursor: pointer; text-decoration: none; transition: all 0.15s; }
  .dl-btn:hover { background: rgba(74,240,168,0.12); border-color: var(--accent); }
  .dl-btn-name { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--accent); }
  .dl-btn-size { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--muted); }

  .sidebar::-webkit-scrollbar { width: 4px; }
  .sidebar::-webkit-scrollbar-track { background: transparent; }
  .sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* Search */
  .search-control {
    position: absolute;
    top: 12px;
    left: 12px;
    z-index: 1000;
    width: 280px;
  }
  .search-wrap {
    display: flex;
    align-items: center;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    transition: border-color 0.15s;
  }
  .search-wrap:focus-within { border-color: var(--accent); }
  .search-icon { padding: 0 10px; color: var(--muted); font-size: 14px; flex-shrink: 0; }
  .search-input {
    flex: 1;
    padding: 9px 4px;
    background: transparent;
    border: none;
    color: var(--text);
    font-family: Syne, sans-serif;
    font-size: 13px;
    outline: none;
  }
  .search-input::placeholder { color: var(--muted); }
  .search-clear { padding: 0 10px; color: var(--muted); font-size: 16px; cursor: pointer; flex-shrink: 0; display: none; line-height: 1; }
  .search-clear:hover { color: var(--danger); }
  .search-results {
    margin-top: 4px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    display: none;
  }
  .search-results.show { display: block; }
  .search-result-item { padding: 9px 14px; cursor: pointer; font-size: 12px; color: var(--text); border-bottom: 1px solid var(--border); transition: background 0.1s; line-height: 1.4; }
  .search-result-item:last-child { border-bottom: none; }
  .search-result-item:hover { background: var(--surface2); color: var(--accent); }
  .search-result-sub { font-size: 10px; color: var(--muted); font-family: Space Mono, monospace; margin-top: 2px; }
  .search-msg { padding: 10px 14px; font-size: 12px; color: var(--muted); font-family: Space Mono, monospace; }
</style>
</head>
<body>

<header>
  <div>
    <div class="logo">Tirol <span>DGM</span> 3D</div>
    <div class="subtitle">EPSG:31254 ¬∑ Land Tirol</div>
  </div>
  <div class="header-right">
    <div class="badge active" id="status-badge">Bereit</div>
    <div class="badge warning" title="Verf√ºgbarer Bereich: y 167802‚Äì293567 / x -18752‚Äì202157">begrenzt auf Tirol</div>
  </div>
</header>

<div class="main">
  <div style="position:relative;flex:1;display:flex;">
    <div id="map"></div>

    <!-- Search overlay -->
    <div class="search-control" id="search-control" style="margin-left:40px;">
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input class="search-input" id="search-input" type="text" placeholder="Ort suchen..." autocomplete="off">
        <span class="search-clear" id="search-clear" onclick="clearSearch()">‚úï</span>
      </div>
      <div class="search-results" id="search-results"></div>
    </div>
  </div><!-- /map-wrap -->

  <div class="sidebar">
    <!-- Instruction -->
    <div class="panel">
      <div class="panel-title">Anleitung</div>
      <div class="instruction">
        <span class="icon">‚¨õ</span>
        <span>Klicke und ziehe auf der Karte um einen Bereich auszuw√§hlen. Die Auswahl wird automatisch auf den verf√ºgbaren Datensatz in Tirol begrenzt (y 167802‚Äì293567 / x -18752‚Äì202157).</span>
      </div>
    </div>

    <!-- Coordinates -->
    <div class="panel">
      <div class="panel-title">Bounding Box ¬∑ EPSG:31254</div>
      <div class="coord-grid">
        <div class="coord-item" id="coord-ymin">
          <div class="coord-label">y_min</div>
          <div class="coord-value coord-empty" id="val-ymin">‚Äî</div>
        </div>
        <div class="coord-item" id="coord-xmin">
          <div class="coord-label">x_min</div>
          <div class="coord-value coord-empty" id="val-xmin">‚Äî</div>
        </div>
        <div class="coord-item" id="coord-ymax">
          <div class="coord-label">y_max</div>
          <div class="coord-value coord-empty" id="val-ymax">‚Äî</div>
        </div>
        <div class="coord-item" id="coord-xmax">
          <div class="coord-label">x_max</div>
          <div class="coord-value coord-empty" id="val-xmax">‚Äî</div>
        </div>
      </div>
      <div class="area-info" id="area-info" style="display:none">
        <div class="area-chip">
          <div class="val" id="area-w">‚Äî</div>
          <div class="unit">Breite (km)</div>
        </div>
        <div class="area-chip">
          <div class="val" id="area-h">‚Äî</div>
          <div class="unit">H√∂he (km)</div>
        </div>
        <div class="area-chip">
          <div class="val" id="area-total">‚Äî</div>
          <div class="unit">Fl√§che (km¬≤)</div>
        </div>
      </div>
      <div class="warning" id="size-warning">
        ‚ö† Gro√üer Bereich! Bei 50cm Aufl√∂sung entstehen sehr gro√üe Dateien.
      </div>
    </div>

    <!-- Resolution -->
    <div class="panel">
      <div class="panel-title">Aufl√∂sung</div>
      <div class="res-toggle">
        <div class="res-btn active" id="res-5m" onclick="setResolution('5m')">
          <div>5m</div>
          <div style="font-size:9px;color:var(--muted);margin-top:2px">Standard</div>
        </div>
        <div class="res-btn" id="res-50cm" onclick="setResolution('50cm')">
          <div>50cm</div>
          <div style="font-size:9px;color:var(--muted);margin-top:2px">Sehr gro√ü!</div>
        </div>
      </div>
    </div>

    <!-- GENERATE PANEL (Einstellungen + Button) -->
    <div class="panel">
      <div class="panel-title">3D-Datei generieren</div>

      <div class="gen-options">
        <!-- Downsampling (freies Eingabefeld) -->
        <div class="opt-group">
          <span class="opt-label">Downsampling-Faktor (ganze Zahl)</span>
          <input class="num-input" type="number" id="downsample-input" value="1" min="1" step="1">
        </div>

        <!-- Zielgr√∂√üe -->
        <div class="opt-group">
          <span class="opt-label">Seitenl√§nge Ausgabe (mm)</span>
          <input class="num-input" type="number" id="target-mm" value="100" min="10" max="1000" step="10">
        </div>

        <!-- Geschlossen / offen -->
        <div class="opt-group">
          <span class="opt-label">Volumen</span>
          <div class="opt-row">
            <button class="tog-btn active" id="closed-no" onclick="setClosed(false)">Offen</button>
            <button class="tog-btn" id="closed-yes" onclick="setClosed(true)">Geschlossen</button>
          </div>
        </div>

        <!-- Format -->
        <div class="opt-group">
          <span class="opt-label">Format</span>
          <div class="opt-row">
            <button class="tog-btn active" data-fmt="stl" onclick="setFmt(this)">STL</button>
            <button class="tog-btn" data-fmt="obj" onclick="setFmt(this)">OBJ</button>
            <button class="tog-btn" data-fmt="both" onclick="setFmt(this)">Beide</button>
          </div>
        </div>
      </div>

      <button class="gen-btn" id="gen-btn" onclick="startGenerate()" disabled>
        ‚ñ∂ GENERIEREN
      </button>

      <!-- Log-Ausgabe und Downloads -->
      <div class="log-box" id="log-box"></div>
      <div class="dl-list" id="dl-list"></div>
    </div>

    <!-- Auswahl l√∂schen -->
    <div class="panel">
      <button class="clear-btn" onclick="clearSelection()">‚úï Auswahl l√∂schen</button>
    </div>
  </div><!-- /sidebar -->
</div><!-- /main -->

<script>
// ‚îÄ‚îÄ PROJ (EPSG:31254 ‚áî WGS84) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toEPSG31254(lat, lon) {
  const dX=577.326, dY=90.129, dZ=463.919;
  const rX=5.137/206265, rY=1.474/206265, rZ=5.297/206265, s=2.4232/1e6;
  const a_wgs=6378137.0, f_wgs=1/298.257223563;
  const b_wgs=a_wgs*(1-f_wgs), e2_wgs=1-(b_wgs/a_wgs)**2;
  const latR=lat*Math.PI/180, lonR=lon*Math.PI/180;
  const sinLat=Math.sin(latR), cosLat=Math.cos(latR), sinLon=Math.sin(lonR), cosLon=Math.cos(lonR);
  const N_wgs=a_wgs/Math.sqrt(1-e2_wgs*sinLat**2), h=50;
  const X=(N_wgs+h)*cosLat*cosLon, Y=(N_wgs+h)*cosLat*sinLon, Z=(N_wgs*(1-e2_wgs)+h)*sinLat;
  const Xb=(1+s)*(X + rZ*Y - rY*Z) + dX;
  const Yb=(1+s)*(-rZ*X + Y + rX*Z) + dY;
  const Zb=(1+s)*(rY*X - rX*Y + Z) + dZ;
  const a_bes=6377397.155, f_bes=1/299.1528128;
  const b_bes=a_bes*(1-f_bes), e2_bes=1-(b_bes/a_bes)**2;
  const p=Math.sqrt(Xb**2+Yb**2);
  let lat_bes=Math.atan2(Zb, p*(1-e2_bes));
  for(let i=0;i<10;i++){const N_=a_bes/Math.sqrt(1-e2_bes*Math.sin(lat_bes)**2);lat_bes=Math.atan2(Zb+e2_bes*N_*Math.sin(lat_bes), p);}
  const lon_bes=Math.atan2(Yb, Xb);
  const lon0=10.333333333333*Math.PI/180, dlon=lon_bes-lon0;
  const sinB=Math.sin(lat_bes), cosB=Math.cos(lat_bes), tanB=Math.tan(lat_bes);
  const N_b=a_bes/Math.sqrt(1-e2_bes*sinB**2), e2_=e2_bes*cosB**2/(1-e2_bes), t=tanB, n2=e2_, dl=dlon;
  const n=(a_bes-b_bes)/(a_bes+b_bes);
  const A0=1 - n**2/4 - 3*n**4/64, A2=3/2*(n - 3*n**3/16), A4=15/16*(n**2 - n**4/4), A6=35/48*n**3;
  const M=a_bes*(A0*lat_bes - A2*Math.sin(2*lat_bes) + A4*Math.sin(4*lat_bes) - A6*Math.sin(6*lat_bes)) / (1+n);
  const x_gk = M + N_b*sinB*cosB/2*dl**2 + N_b*sinB*cosB**3/24*(5-t**2+9*n2+4*n2**2)*dl**4;
  const y_gk = N_b*cosB*dl + N_b*cosB**3/6*(1-t**2+n2)*dl**3 + N_b*cosB**5/120*(5-18*t**2+t**4+14*n2-58*n2*t**2)*dl**5;
  return { y: Math.round(x_gk - 5000000), x: Math.round(y_gk) };
}

function from31254toLonLat(y31254, x31254) {
  const a_bes=6377397.155, f_bes=1/299.1528128;
  const b_bes=a_bes*(1-f_bes), e2=1-(b_bes/a_bes)**2;
  const lon0=10.333333333333*Math.PI/180;
  const n=(a_bes-b_bes)/(a_bes+b_bes);
  const M = y31254 + 5000000, y_gk = x31254;
  const mu = M / (a_bes * (1 - e2/4 - 3*e2**2/64 - 5*e2**3/256));
  const e1 = (1 - Math.sqrt(1-e2)) / (1 + Math.sqrt(1-e2));
  const lat_fp = mu + (3/2*e1 - 27/32*e1**3)*Math.sin(2*mu) + (21/16*e1**2 - 55/32*e1**4)*Math.sin(4*mu) + 151/96*e1**3*Math.sin(6*mu) + 1097/512*e1**4*Math.sin(8*mu);
  const sinFP=Math.sin(lat_fp), cosFP=Math.cos(lat_fp), tanFP=Math.tan(lat_fp);
  const N1=a_bes/Math.sqrt(1-e2*sinFP**2), T1=tanFP**2, C1=e2/(1-e2)*cosFP**2;
  const R1=a_bes*(1-e2)/Math.pow(1-e2*sinFP**2,1.5), D=y_gk/(N1);
  const lat_bes = lat_fp - N1*tanFP/R1*(D**2/2 - (5+3*T1+10*C1-4*C1**2-9*e2/(1-e2))*D**4/24);
  const lon_bes = lon0 + (D - (1+2*T1+C1)*D**3/6 + (5-2*C1+28*T1-3*C1**2+8*e2/(1-e2)+24*T1**2)*D**5/120)/cosFP;
  const dX=-577.326,dY=-90.129,dZ=-463.919, rX=-5.137/206265,rY=-1.474/206265,rZ=-5.297/206265, s=-2.4232/1e6;
  const e2b=1-(b_bes/a_bes)**2, sinB=Math.sin(lat_bes),cosB=Math.cos(lat_bes);
  const N_b=a_bes/Math.sqrt(1-e2b*sinB**2), h=50;
  const Xb=(N_b+h)*cosB*Math.cos(lon_bes), Yb=(N_b+h)*cosB*Math.sin(lon_bes), Zb=(N_b*(1-e2b)+h)*sinB;
  const Xw=(1+s)*(Xb + rZ*Yb - rY*Zb) + dX, Yw=(1+s)*(-rZ*Xb + Yb + rX*Zb) + dY, Zw=(1+s)*(rY*Xb - rX*Yb + Zb) + dZ;
  const a_wgs=6378137.0, f_wgs=1/298.257223563, b_wgs=a_wgs*(1-f_wgs), e2w=1-(b_wgs/a_wgs)**2;
  const pp=Math.sqrt(Xw**2+Yw**2);
  let lat_w=Math.atan2(Zw, pp*(1-e2w));
  for(let i=0;i<10;i++){const Nw=a_wgs/Math.sqrt(1-e2w*Math.sin(lat_w)**2);lat_w=Math.atan2(Zw+e2w*Nw*Math.sin(lat_w), pp);}
  return [lat_w*180/Math.PI, Math.atan2(Yw, Xw)*180/Math.PI];
}

// ‚îÄ‚îÄ Grenzen des verf√ºgbaren DGM-Gebiets (EPSG:31254) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Y_MIN = 167802;
const Y_MAX = 293567;
const X_MIN = -18752;
const X_MAX = 202157;

// ‚îÄ‚îÄ MAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const map = L.map('map', { center: [47.2, 11.4], zoom: 9, zoomControl: true });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap', maxZoom: 19 }).addTo(map);
// Optional: Verf√ºgbaren Bereich als unscharfes Rechteck andeuten (in WGS84 umgerechnet)
const swBounds = from31254toLonLat(Y_MIN, X_MIN);
const neBounds = from31254toLonLat(Y_MAX, X_MAX);
L.rectangle([swBounds, neBounds], { color: '#f0a84a', weight: 1, opacity: 0.2, fill: false, dashArray: '4 4' }).addTo(map);

// right‚Äëclick drag
let isRightDragging = false, lastMousePos = null;
map.getContainer().addEventListener('mousedown', e => { if (e.button === 2) { e.preventDefault(); isRightDragging = true; lastMousePos = { x: e.clientX, y: e.clientY }; map.getContainer().style.cursor = 'grabbing'; } });
window.addEventListener('mousemove', e => { if (!isRightDragging) return; e.preventDefault(); const dx = e.clientX - lastMousePos.x, dy = e.clientY - lastMousePos.y; if (dx||dy) { map.panBy([-dx,-dy],{animate:false}); lastMousePos={x:e.clientX,y:e.clientY}; } });
window.addEventListener('mouseup', () => { if(isRightDragging){isRightDragging=false;map.getContainer().style.cursor='crosshair';} });
map.getContainer().addEventListener('contextmenu', e => e.preventDefault());

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let isDrawing=false, startLatLng=null, currentRect=null, selectedBbox=null;
let currentRes='5m', closedBody=false, fmtVal='stl';

// ‚îÄ‚îÄ DRAW (mit automatischem Clipping an die Grenzen) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
map.on('mousedown', e => {
  if (e.originalEvent.button !== 0) return;
  isDrawing=true; startLatLng=e.latlng;
  if (currentRect) { map.removeLayer(currentRect); currentRect=null; }
  map.dragging.disable();
  document.getElementById('status-badge').textContent='Zeichnen...';
});
map.on('mousemove', e => {
  if (!isDrawing||!startLatLng) return;
  if (currentRect) map.removeLayer(currentRect);
  // W√§hrend des Ziehens zeigen wir vorl√§ufig das volle Rechteck (ohne Clipping) an.
  currentRect = L.rectangle([startLatLng, e.latlng], { color:'#4af0a8', weight:2, opacity:0.9, fillColor:'#4af0a8', fillOpacity:0.08 }).addTo(map);
});
map.on('mouseup', e => {
  if (!isDrawing) return;
  isDrawing=false; map.dragging.enable();
  if (!startLatLng) return;

  // Roh-Koordinaten in EPSG:31254 umrechnen
  const p1=toEPSG31254(startLatLng.lat,startLatLng.lng);
  const p2=toEPSG31254(e.latlng.lat,e.latlng.lng);
  let ymin = Math.min(p1.y, p2.y);
  let ymax = Math.max(p1.y, p2.y);
  let xmin = Math.min(p1.x, p2.x);
  let xmax = Math.max(p1.x, p2.x);

  // Auf verf√ºgbaren Bereich clippen
  ymin = Math.max(ymin, Y_MIN);
  ymax = Math.min(ymax, Y_MAX);
  xmin = Math.max(xmin, X_MIN);
  xmax = Math.min(xmax, X_MAX);

  // Pr√ºfen, ob noch eine g√ºltige Fl√§che √ºbrig ist
  if (ymin > ymax || xmin > xmax) {
    alert('Die Auswahl liegt vollst√§ndig au√üerhalb des verf√ºgbaren Gebiets (Tirol).');
    if (currentRect) map.removeLayer(currentRect);
    document.getElementById('status-badge').textContent = 'Bereit';
    return;
  }

  // Auswahl speichern
  selectedBbox = { ymin, xmin, ymax, xmax };

  // Korrigiertes Rechteck in WGS84 berechnen und anzeigen
  const sw = from31254toLonLat(ymin, xmin);
  const ne = from31254toLonLat(ymax, xmax);
  if (currentRect) map.removeLayer(currentRect);
  currentRect = L.rectangle([sw, ne], { color:'#4af0a8', weight:2, opacity:0.9, fillColor:'#4af0a8', fillOpacity:0.08 }).addTo(map);

  updateUI(ymin, xmin, ymax, xmax);

  // Status mit Hinweis auf ggf. erfolgte Beschneidung
  if (ymin > p1.y || ymax < p2.y || xmin > p1.x || xmax < p2.x) {
    document.getElementById('status-badge').textContent = 'Auswahl beschnitten';
  } else {
    document.getElementById('status-badge').textContent = 'Ausgew√§hlt';
  }
});

// ‚îÄ‚îÄ UI UPDATE (Koordinaten, Warnung, Aktivierung Gen‚ÄëButton) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateUI(ymin,xmin,ymax,xmax) {
  document.getElementById('val-ymin').textContent=ymin.toLocaleString('de-AT');
  document.getElementById('val-xmin').textContent=xmin.toLocaleString('de-AT');
  document.getElementById('val-ymax').textContent=ymax.toLocaleString('de-AT');
  document.getElementById('val-xmax').textContent=xmax.toLocaleString('de-AT');
  ['coord-ymin','coord-xmin','coord-ymax','coord-xmax'].forEach(id=>document.getElementById(id).classList.add('highlight'));
  const wM=ymax-ymin, hM=xmax-xmin, areaSqKm=(wM*hM/1e6).toFixed(1);
  document.getElementById('area-w').textContent=(wM/1000).toFixed(1);
  document.getElementById('area-h').textContent=(hM/1000).toFixed(1);
  document.getElementById('area-total').textContent=areaSqKm;
  document.getElementById('area-info').style.display='flex';
  const warn=document.getElementById('size-warning');
  if(parseFloat(areaSqKm)>25 && currentRes==='50cm') warn.classList.add('show'); else warn.classList.remove('show');
  document.getElementById('gen-btn').disabled=false;
}

function setResolution(res) {
  currentRes=res;
  document.getElementById('res-5m').className='res-btn'+(res==='5m'?' active':'');
  document.getElementById('res-50cm').className='res-btn'+(res==='50cm'?' active':'');
  if(selectedBbox){const{ymin,xmin,ymax,xmax}=selectedBbox; updateUI(ymin,xmin,ymax,xmax);}
}

function clearSelection() {
  if(currentRect){map.removeLayer(currentRect);currentRect=null;}
  selectedBbox=null;
  document.getElementById('val-ymin').textContent='‚Äî';
  document.getElementById('val-xmin').textContent='‚Äî';
  document.getElementById('val-ymax').textContent='‚Äî';
  document.getElementById('val-xmax').textContent='‚Äî';
  ['coord-ymin','coord-xmin','coord-ymax','coord-xmax'].forEach(id=>document.getElementById(id).classList.remove('highlight'));
  document.getElementById('area-info').style.display='none';
  document.getElementById('size-warning').classList.remove('show');
  document.getElementById('status-badge').textContent='Bereit';
  document.getElementById('gen-btn').disabled=true;
  document.getElementById('log-box').classList.remove('show');
  document.getElementById('dl-list').innerHTML='';
}

// ‚îÄ‚îÄ GENERATE OPTIONS (Downsample jetzt aus Input) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setClosed(v) {
  closedBody=v;
  document.getElementById('closed-no').className='tog-btn'+(v?'':' active');
  document.getElementById('closed-yes').className='tog-btn'+(v?' active':'');
}
function setFmt(btn) {
  document.querySelectorAll('[data-fmt]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  fmtVal=btn.dataset.fmt;
}

// ‚îÄ‚îÄ GENERATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SERVER = 'http://localhost:5000';
let pollTimer = null;

function startGenerate() {
  if (!selectedBbox) return;

  const dsInput = document.getElementById('downsample-input');
  const dsVal = parseInt(dsInput.value, 10);
  if (isNaN(dsVal) || dsVal < 1) {
    alert('Bitte einen g√ºltigen Downsampling-Faktor (ganze Zahl ‚â• 1) eingeben.');
    return;
  }

  const {ymin,xmin,ymax,xmax} = selectedBbox;
  const coverageName = currentRes==='5m' ? 'Gelaendemodell_5m_M28' : 'Gelaendemodell_50cm_M28';
  const targetMm = parseFloat(document.getElementById('target-mm').value) || 100;

  const genBtn = document.getElementById('gen-btn');
  const logBox = document.getElementById('log-box');
  const dlList = document.getElementById('dl-list');

  genBtn.disabled = true;
  genBtn.classList.add('loading');
  genBtn.textContent = '‚è≥ Wird verarbeitet...';
  logBox.innerHTML = '';
  logBox.classList.add('show');
  dlList.innerHTML = '';

  addLog('Verbinde mit Server...');

  fetch(`${SERVER}/generate`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      bbox: [ymin, xmin, ymax, xmax],
      coverage_name: coverageName,
      downsample: dsVal,
      closed_body: closedBody,
      target_mm: targetMm,
      format: fmtVal,
    })
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) throw new Error(data.error);
    addLog(`Job gestartet: ${data.job_id.slice(0,8)}...`);
    pollJob(data.job_id);
  })
  .catch(err => {
    addLog('ERROR: ' + err.message, true);
    addLog('L√§uft der Server? python server.py', true);
    resetGenBtn();
  });
}

function pollJob(jobId) {
  pollTimer = setInterval(() => {
    fetch(`${SERVER}/status/${jobId}`)
      .then(r => r.json())
      .then(data => {
        const logBox = document.getElementById('log-box');
        const existing = logBox.children.length;
        const allLogs = data.log || [];
        for (let i = existing; i < allLogs.length; i++) {
          addLog(allLogs[i]);
        }

        if (data.status === 'done') {
          clearInterval(pollTimer);
          addLog('‚úì Fertig!', false, true);
          showDownloads(data.files);
          resetGenBtn('‚úì Fertig ‚Äì Neu generieren');
        } else if (data.status === 'error') {
          clearInterval(pollTimer);
          addLog('ERROR: ' + data.error, true);
          resetGenBtn();
        }
      })
      .catch(() => {});
  }, 1000);
}

function addLog(msg, isErr=false, isOk=false) {
  const logBox = document.getElementById('log-box');
  const line = document.createElement('div');
  line.className = 'log-line' + (isErr?' err':'') + (isOk?' ok':'');
  line.textContent = msg;
  logBox.appendChild(line);
  logBox.scrollTop = logBox.scrollHeight;
}

function showDownloads(files) {
  const dlList = document.getElementById('dl-list');
  dlList.innerHTML = '';
  (files||[]).forEach(f => {
    const a = document.createElement('a');
    a.className = 'dl-btn';
    a.href = `${SERVER}/download/${f.name}`;
    a.download = f.name;
    a.innerHTML = `<span class="dl-btn-name">‚¨á ${f.name}</span><span class="dl-btn-size">${f.size_mb} MB</span>`;
    dlList.appendChild(a);
  });
}

function resetGenBtn(label='‚ñ∂ GENERIEREN') {
  const genBtn = document.getElementById('gen-btn');
  genBtn.disabled = false;
  genBtn.classList.remove('loading');
  genBtn.textContent = label;
}

// ‚îÄ‚îÄ SEARCH (Nominatim) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let searchTimer = null;
let searchMarker = null;

const searchInput = document.getElementById('search-input');
const searchResults = document.getElementById('search-results');
const searchClear = document.getElementById('search-clear');

searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim();
  searchClear.style.display = q ? 'block' : 'none';
  clearTimeout(searchTimer);
  if (q.length < 2) { hideResults(); return; }
  searchTimer = setTimeout(() => doSearch(q), 350);
});
searchInput.addEventListener('keydown', e => {
  if (e.key === 'Escape') clearSearch();
  if (e.key === 'Enter') {
    const first = searchResults.querySelector('.search-result-item');
    if (first) first.click();
  }
});
document.addEventListener('click', e => {
  if (!document.getElementById('search-control').contains(e.target)) hideResults();
});

async function doSearch(q) {
  searchResults.innerHTML = '<div class="search-msg">Suche...</div>';
  searchResults.classList.add('show');
  try {
    const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=6&countrycodes=at&q=' + encodeURIComponent(q);
    const res = await fetch(url, { headers: { 'Accept-Language': 'de' } });
    const data = await res.json();
    if (!data.length) {
      searchResults.innerHTML = '<div class="search-msg">Keine Ergebnisse</div>';
      return;
    }
    searchResults.innerHTML = '';
    data.forEach(item => {
      const div = document.createElement('div');
      div.className = 'search-result-item';
      const name = item.display_name.split(',')[0];
      const sub  = item.display_name.split(',').slice(1,3).join(',').trim();
      div.innerHTML = '<div>' + name + '</div><div class="search-result-sub">' + sub + '</div>';
      div.addEventListener('click', () => { selectResult(item, name); });
      searchResults.appendChild(div);
    });
  } catch(e) {
    searchResults.innerHTML = '<div class="search-msg">Fehler bei der Suche</div>';
  }
}

function selectResult(item, name) {
  const lat = parseFloat(item.lat), lon = parseFloat(item.lon);
  if (item.boundingbox) {
    map.fitBounds([[parseFloat(item.boundingbox[0]), parseFloat(item.boundingbox[2])],[parseFloat(item.boundingbox[1]), parseFloat(item.boundingbox[3])]], { maxZoom:14, padding:[30,30] });
  } else {
    map.setView([lat, lon], 13);
  }
  if (searchMarker) map.removeLayer(searchMarker);
  searchMarker = L.circleMarker([lat, lon], {
    radius: 7, color: '#f0a84a', fillColor: '#f0a84a', fillOpacity:0.9, weight:2
  }).addTo(map).bindPopup(name).openPopup();

  searchInput.value = name;
  searchClear.style.display = 'block';
  hideResults();
}

function hideResults() { searchResults.classList.remove('show'); }
function clearSearch() {
  searchInput.value = '';
  searchClear.style.display = 'none';
  hideResults();
  if (searchMarker) { map.removeLayer(searchMarker); searchMarker = null; }
}
</script>
</body>
</html>